# UDP4500_Canceller

# 目的
VPN機能付きUPnP対応ルータ配下でどこでもMyMacとVPN機能を併用するためにUPnP設定を調整する。

### 想定する具体的環境
- フレッツ光HGW「PR-500MI」
  - PPPoEが動いている
  - VPNサーバ機能が有効
- Apple TimeCapsule
  - どこでもMyMac機能(ファイル共有)が有効

# 使い方
`UDP4500_Canceller.php [options]`
- _-x_ : UPnP設定変更を行う。指定しない場合には情報表示のみ行って設定変更を実行しない
- _-q_ : 表示抑制。cronにて実行する場合に指定することを想定。
- _-h_ : ヘルプメッセージ表示。(現状未実装)

# 想定している事象
どこでもMyMac(TimeCapsule内のファイルをインターネット越しに利用するファイル共有)を利用するためには
TimeCapsuleをUPnP対応ルータ配下におく必要がある。
しかし、フレッツ光のホームゲートウェイ(HGW)であるPR-500MIでは、
UPnPに対応したルーターであるにもかかわらず
ファイル共有が利用できない事象が発生する。
(外部NW上のMacのFinderに共有ディスクとして表示されるが、接続できない状態となる)

これは、UPnPにより設定されたどこでもMyMacで使うポートマッピング情報が
ルータ本体のVPN機能と競合し、正しくポート転送されないために発生する(*と思われる*)。

具体的には、UPnPにより WAN側:UDP45000→TimeCapsul:UDP4500 のポートマッピングが設定されているにもかかわらず、
PR-500MIのVPN機能が有効である場合にはVPN機能自身がUDP4500を着信してしまい、TimeCapsule宛に転送されない。
(設定されたポートマッピングが動作しない)

# 動作
- 4500/UDPに対するUPnP設定が**ある**場合
  - UPnP設定が本APによる設定である場合：
    - その状態を維持するため、UPnP設定情報を再送することにより更新する。
  - UPnP設定が本APによる設定でない場合：
    - 他の機器(どこでもMyMac機器である可能性がある)が4500/UDPを使用中と思われる。
    - 一旦、本APにより他機器のUPnP設定を削除し、改めて本APにより、ダミーのUPnPエントリーを設定する。
    - これにより「他の機器」は次回UPnP情報を更新した際に4500/UDP以外のポートを利用するようになる。
- 4500/UDPに対するUPnP設定が**ない**場合
  - 本APにより、ダミーのUPnPエントリーを設定する。
    - これにより他機器(TimeCapsule)が4500/UDP以外のポートを利用するようになる。

