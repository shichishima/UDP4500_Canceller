# *以下、書きかけ*

# UDP4500_Canceller

# 目的
VPN機能付きUPnP対応ルータ配下でどこでもMyMac(Back To My Mac; BTMM)とVPN機能を併用するためにUPnP設定を調整する。
ルータ&AirMac機器と同一NW内にある別端末(Mac or RaspberryPiを想定)上で本スクリプトを実行する。

### 想定する具体的環境
- フレッツ光HGW「PR-500MI」
  - PPPoEが動いている
  - VPNサーバ機能が有効
- Apple TimeCapsule
  - PR-500MI配下
  - どこでもMyMac機能(ファイル共有)が有効
- Raspberry Pi
  - PR-500MI配下、TImeCapsuleと同一サブネット内。
  - 本スクリプトをcronで定期実行

# 使い方
`UDP4500_Canceller.php [options]`
- _-x_ UPnP設定変更を行う。指定しない場合には情報表示のみ行って設定変更を実行しない
- _-q_ 表示抑制。cronにて実行する場合に指定することを想定。
- _-h_ ヘルプメッセージ表示。(現状未実装)

# 想定している事象
どこでもMyMac(TimeCapsule内のファイルをインターネット越しに利用するファイル共有)を利用するためには
TimeCapsuleをUPnP対応ルータ配下におく必要がある。
しかし、フレッツ光のホームゲートウェイ(HGW)であるPR-500MIでは、
UPnPに対応したルーターであるにもかかわらず
ファイル共有が利用できない事象が発生する。
(外部NW上のMacのFinderに共有ディスクとして表示されるが、接続できない状態となる)

これは、UPnPにより設定されたどこでもMyMacで使うポートマッピング情報が
ルータ本体のVPN機能と競合し、正しくポート転送されないために発生する(*と思われる*)。

具体的には、UPnPにより WAN側:UDP45000→TimeCapsul:UDP4500 のポートマッピングが設定されているにもかかわらず、
PR-500MIのVPN機能が有効である場合にはVPN機能自身がUDP4500を着信してしまい、TimeCapsule宛に転送されない。
(設定されたポートマッピングが動作しない)

# 挙動詳細
`upnpc -l`またはPR-500MIの「UPnP NAT設定情報」および「UPnPログ」から観察した挙動は以下のとおり。

### 1. NGな状態

|プロトコル|WAN側ポート||LAN側端末|LAN側端末の宛先ポート|サービス名|
|:--:|:--:|:--:|:--:|:--:|:--:|
|UDP|4500|→|TimeCapsule|4500|iC4500|
|UDP|4501|→|AirMacExpress|4500|iC4501|

外部NWからTimeCapsule宛のどこでもMyMac用通信が4500/UDPを使うようにポートマッピング設定されている。
しかし、この設定項目はVPNと競合し使えない。
(ここの挙動はルータ機器による。
PR-500MIはUPnPポートマッピング設定状態よりもVPNサーバ機能が優先する。
VPNサーバ機能よりもUPnPが優先する機器があるかもしれない。
また手動でのポートマッピング設定とUPnPによるポートマッピング設定の優先度も機器により様々と思われる)

なおAirMacExpressはポート4501なので外部NWから接続できる。
(AirMacユーティリティーから接続でき、設定変更画面を開くことができる)

### 2. 本スクリプトを実行

RaspberryPi上で本スクリプトを実行すると、TimeCapsule宛の4500を削除しダミー設定を追加する。
```
  1. 2015/01/01 01:49:30 192.168.1.10 サービスの登録 有効 192.168.1.10 UDP 4500  4500 無期限
  2. 2015/01/01 01:49:28 192.168.1.10 サービスの削除 有効 192.168.1.2 UDP 4500  4500 無期限
```
|プロトコル|WAN側ポート||LAN側端末|LAN側端末の宛先ポート|サービス名|
|:--:|:--:|:--:|:--:|:--:|:--:|
|UDP|4500|→|RaspberryPi|4500|libminiupnpc|
|UDP|4501|→|AirMacExpress|4500|iC4501|

このとき設定されるService Descriptionは使用するupnpcコマンドのバージョンによって異なる。
Mac brew版(-eオプションが使える場合)は「UDP4500 Canceller」、
RaspberryPi apt-get版(-eオプションが使えない場合)は「libminiupnpc」となる。

### 3. その後のOK状態

その後放置するとTimeCapsuleのUPnP更新動作がおきる。
(更新間隔＝約59分)
```
  8. 2015/01/01 02:45:33 192.168.1.2 サービスの登録 有効 192.168.1.2 UDP 4500  4502 無期限
  9. 2015/01/01 02:45:33 192.168.1.2 サービスの登録不可 有効 192.168.1.2 UDP 4500  4501 無期限
 10. 2015/01/01 02:45:33 192.168.1.2 サービスの登録不可 有効 192.168.1.2 UDP 4500  4500 無期限
```
|プロトコル|WAN側ポート||LAN側端末|LAN側端末の宛先ポート|サービス名|
|:--:|:--:|:--:|:--:|:--:|:--:|
|UDP|4500|→|RaspberryPi|4500|libminiupnpc|
|UDP|4501|→|AirMacExpress|4500|iC4501|
|UDP|4502|→|TimeCapsule|4500|iC4502|

TimeCapsuleは、まず以前のポート(UDP4500)での更新を試みる。
しかしルータからは別サービスにて使用中との応答があるため、
ポート番号を+1しながら最初の空きポートを探す。
この例では4502を利用することとなる。

### 4. TimeCapsuleのUPnP更新

この状態で放置すると、次回のTimeCapsuleのUPnP更新動作は4502に対して更新を試みる。
一発で成功し、引き続きUDP4502にて待ち受けることとなる。

```
  6. 2015/01/01 03:44:10 192.168.1.2 サービスの更新 有効 192.168.1.2 UDP 4500  4502 無期限
```

### 5. UPnP設定の自動削除と対策

しかし、さらに放置すると本スクリプトで設定したUDP4500設定が消えてしまう。
(最終更新から24時間後)

```
  1. 2015/01/02 01:30:38 - サービスの自動削除 有効 192.168.1.10 UDP 4500  4500 無期限
   :
 53. 2015/01/01 01:30:36 192.168.1.10 サービスの更新 有効 192.168.1.10 UDP 4500  4500 無期限
```

既存のTimeCapsuleとAirMacExpressはそれぞれ現在のポート4502および4501で更新するので問題ないが、
NWに新たなどこでもMyMac機器が参加すると初回接続時にデフォルトポートUDP4500での設定を試み、
これは成功してしまう。(1.の状態に戻る)
このため、本スクリプトによるUDP4500設定が消えてしまわないよう、
cron等で定期的にUDP4500に対する更新処理を行わなければならない。

# 本スクリプトの動作
- 4500/UDPに対するUPnP設定が**ある**場合
  - UPnP設定が本APによる設定である場合：
    - その状態を維持するため、UPnP設定情報を再送することにより更新する。
  - UPnP設定が本APによる設定でない場合：
    - 他の機器(どこでもMyMac機器である可能性がある)が4500/UDPを使用中と思われる。
    - 一旦、本APにより他機器のUPnP設定を削除し、改めて本APにより、ダミーのUPnPエントリーを設定する。
    - これにより「他の機器」は次回UPnP情報を更新した際に4500/UDP以外のポートを利用するようになる。
- 4500/UDPに対するUPnP設定が**ない**場合
  - 本APにより、ダミーのUPnPエントリーを設定する。
    - これにより他機器(TimeCapsule等)が4500/UDP以外のポートを利用するようになる。

